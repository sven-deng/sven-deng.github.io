---
layout: post
title: "C4 Model"
subtitle: "ä½¿ç”¨C4  Model ä¸ºé¡¹ç›®ç¼–åˆ¶å›¾è¡¨æ–‡æ¡£"
date: 2023-01-05
author: "sven"
header-img: "img/post-bg-2015.jpg"
tags: ["tool" , "architecture" , "document"]
---

> ä¸äº†è§£å°±æ— æ³•çœŸæ­£æ‹¥æœ‰ã€‚  &nbsp;&nbsp;&nbsp;&nbsp; --æ­Œå¾·

## èƒŒæ™¯çŸ¥è¯†
æ— è®ºæ˜¯clean architecture è¿˜æ˜¯ Big ball of mudï¼Œéƒ½éœ€è¦ä¸€ä»½å®Œå¤‡çš„é¡¹ç›®æ–‡æ¡£ä¾›å›¢é˜Ÿæˆå‘˜ç»Ÿä¸€è®¾è®¡æ€æƒ³ã€‚è½¯ä»¶æ¶æ„å›¾æ˜¯ä¸€ç§éå¸¸å¥½çš„è¡¨è¾¾æ–¹å¼ï¼Œå®ƒä¹Ÿæ˜¯é¡¹ç›®è®¾è®¡æ–‡æ¡£ä¸­å¿…ä¸å¯ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚ æ¶æ„å¸ˆå¯ä»¥ç”¨å®ƒä»¬æ¥è¡¨è¾¾å¦‚ä½•æ„å»ºä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿï¼ˆé¢„å…ˆè®¾è®¡ï¼‰æˆ–è€…ç°æœ‰çš„è½¯ä»¶ç³»ç»Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚<br>
å«ç³Šä¸æ¸…çš„è½¯ä»¶æ¶æ„å›¾å®¹æ˜“å¯¼è‡´è¯¯è§£ï¼Œè¿™å¯èƒ½ä¼šæ‹–æ…¢ä¸€ä¸ªä¼˜ç§€å›¢é˜Ÿçš„å‰è¿›æ­¥ä¼ã€‚<br>
C4 æ¨¡å‹ ä»£è¡¨ï¼š
1. ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰
2. å®¹å™¨ï¼ˆContainerï¼‰
3. ç»„ä»¶ï¼ˆComponentï¼‰
4. ä»£ç ï¼ˆCodeï¼‰


ä¸€ç³»åˆ—åˆ†å±‚çš„å›¾è¡¨ï¼Œå¯ä»¥ç”¨è¿™äº›å›¾è¡¨æ¥æè¿°ä¸åŒç¼©æ”¾çº§åˆ«çš„è½¯ä»¶æ¶æ„ï¼Œæ¯ç§å›¾è¡¨éƒ½é€‚ç”¨äºä¸åŒçš„å—ä¼—ã€‚å¯ä»¥å°†å…¶è§†ä¸ºè½¯ä»¶é¡¹ç›®çš„è°·æ­Œåœ°å›¾ã€‚ 
![Google Map different zoom level](/img/post-2023-01/google-map-zoom-level.png)

#### ç¬¬1 å±‚ï¼šç³»ç»Ÿä¸Šä¸‹æ–‡

å®ƒæ˜¾ç¤ºäº†ä½ æ­£åœ¨æ„å»ºçš„è½¯ä»¶ç³»ç»Ÿï¼Œä»¥åŠç³»ç»Ÿä¸ç”¨æˆ·åŠå…¶ä»–è½¯ä»¶ç³»ç»Ÿä¹‹é—´çš„å…³ç³»ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç³»ç»Ÿä¸Šä¸‹æ–‡å›¾çš„ç¤ºä¾‹ï¼Œæè¿°äº†ä¸€ä¸ªäº’è”ç½‘é“¶è¡Œç³»ç»Ÿçš„ç³»ç»Ÿä¸Šä¸‹æ–‡ï¼š
![img](/img/post-2023-01/level1.webp)
#### ç¬¬2 å±‚ï¼šå®¹å™¨

å®ƒå°†è½¯ä»¶ç³»ç»Ÿæ”¾å¤§ï¼Œæ˜¾ç¤ºç»„æˆè¯¥è½¯ä»¶ç³»ç»Ÿçš„å®¹å™¨ï¼ˆåº”ç”¨ç¨‹åºã€æ•°æ®å­˜å‚¨ã€å¾®æœåŠ¡ç­‰ï¼‰ã€‚æŠ€æœ¯å†³ç­–ä¹Ÿæ˜¯è¯¥å›¾çš„å…³é”®éƒ¨åˆ†ã€‚ä»¥ä¸‹æ˜¯äº’è”ç½‘é“¶è¡Œç³»ç»Ÿçš„å®¹å™¨å›¾ç¤ºä¾‹ã€‚å®ƒæ˜¾ç¤ºäº†äº’è”ç½‘é“¶è¡Œç³»ç»Ÿï¼ˆè™šçº¿æ¡†ï¼‰ç”±äº”ä¸ªå®¹å™¨ç»„æˆï¼šæœåŠ¡å™¨ç«¯Web åº”ç”¨ç¨‹åºã€å®¢æˆ·ç«¯å•é¡µé¢åº”ç”¨ç¨‹åºã€ç§»åŠ¨åº”ç”¨ç¨‹åºã€æœåŠ¡å™¨ç«¯API åº”ç”¨ç¨‹åºå’Œæ•°æ®åº“ã€‚
![img](/img/post-2023-01/level2.webp)
#### ç¬¬ 3 å±‚ï¼šç»„ä»¶

å°†å•ä¸ªå®¹å™¨æ”¾å¤§ï¼Œä»¥æ˜¾ç¤ºå…¶ä¸­çš„ç»„ä»¶ã€‚è¿™äº›ç»„ä»¶æ˜ å°„åˆ°ä»£ç åº“ä¸­çš„çœŸå®æŠ½è±¡ï¼ˆä¾‹å¦‚ä¸€ç»„ä»£ç ï¼‰ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç½‘ä¸Šé“¶è¡Œç³»ç»Ÿçš„ç»„ä»¶å›¾ç¤ºä¾‹ï¼Œæ˜¾ç¤ºäº† API åº”ç”¨ç¨‹åºä¸­çš„ä¸€äº›ç»„ä»¶ï¼ˆè€Œä¸æ˜¯å…¨éƒ¨ï¼‰ã€‚
![img](/img/post-2023-01/level3.webp)
#### ç¬¬4 å±‚ï¼šä»£ç 
æœ€åï¼Œå¦‚æœä½ ç¡®å®æƒ³è¦ï¼Œæˆ–è€…è¯´æœ‰è¿™ä¸ªå¿…è¦ï¼Œå¯ä»¥æ”¾å¤§ä¸ªåˆ«ç»„ä»¶ï¼Œä»¥æ˜¾ç¤ºè¯¥ç»„ä»¶çš„å®ç°æ–¹å¼ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç½‘ä¸Šé“¶è¡Œç³»ç»Ÿçš„UML ç±»å›¾ç¤ºä¾‹ï¼ˆéƒ¨åˆ†ï¼‰ï¼Œæ˜¾ç¤ºäº†ç»„æˆMainframeBankingSystemFacade ç»„ä»¶çš„ä»£ç å…ƒç´ ï¼ˆæ¥å£å’Œç±»ï¼‰ã€‚
![img](/img/post-2023-01/level4.webp)

#### ç¬¦å·
C4 æ¨¡å‹æ²¡æœ‰é¢„å®šä¹‰ä»»ä½•ç‰¹å®šçš„ç¬¦å·ï¼Œä½ åœ¨è¿™äº›ç¤ºä¾‹å›¾ä¸­çœ‹åˆ°çš„æ˜¯ä¸€ä¸ªä¸ªç®€å•çš„ç¬¦å·ï¼Œé€‚ç”¨äºç™½æ¿ã€çº¸å¼ ã€ä¾¿ç­¾ã€ç´¢å¼•å¡ç‰‡å’Œå„ç§å›¾è¡¨å·¥å…·ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ UML ä½œä¸ºç¬¦å·ï¼Œå¹¶é€‚å½“ä½¿ç”¨åŒ…ã€ç»„ä»¶å’ŒåŸå‹ã€‚æ— è®ºä½ ä½¿ç”¨å“ªç§ç¬¦å·ï¼Œæˆ‘éƒ½ä¼šå»ºè®®è®©æ¯ä¸ªå…ƒç´ éƒ½åŒ…å«åç§°ã€å…ƒç´ ç±»å‹ï¼ˆå³â€œäººâ€ã€â€œè½¯ä»¶ç³»ç»Ÿâ€ï¼Œâ€œå®¹å™¨â€æˆ–â€œç»„ä»¶â€ï¼‰ã€æŠ€æœ¯é€‰å‹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œä»¥åŠä¸€äº›æè¿°æ€§æ–‡å­—ã€‚åœ¨å›¾è¡¨ä¸­åŒ…å«å¦‚æ­¤å¤šçš„æ–‡æœ¬å¯èƒ½çœ‹èµ·æ¥å¾ˆä¸å¯»å¸¸ï¼Œä½†è¿™äº›é™„åŠ æ–‡æœ¬æœ‰åŠ©äºæ¶ˆé™¤è½¯ä»¶æ¶æ„å›¾ä¸­é€šå¸¸ä¼šå‡ºç°çš„ä¸æ˜ç¡®çš„è¡¨ç¤ºã€‚

å³ä½¿ç¬¦å·å¯¹ä½ æ¥è¯´æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä»ç„¶è¦ç¡®ä¿ä¸ºè¿™äº›ç¬¦å·æä¾›å›¾ä¾‹ã€‚å›¾ä¾‹ä¸­åº”è¯¥åŒ…æ‹¬é¢œè‰²ã€å½¢çŠ¶ã€é¦–å­—æ¯ç¼©ç•¥è¯ã€çº¿æ¡æ ·å¼ã€è¾¹æ¡†ã€å°ºå¯¸ç­‰ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œç¬¦å·åº”è¯¥åœ¨æ¯ä¸ªç»†èŠ‚å±‚æ¬¡ä¸Šä¿æŒä¸€è‡´ã€‚ä¸‹é¢æ˜¯å‰é¢æ˜¾ç¤ºçš„å®¹å™¨å›¾çš„å›¾ä¾‹ã€‚
![img](/img/post-2023-01/symbol.webp)

#### æ›´å¤šä¿¡æ¯
C4 æ¨¡å‹æ˜¯ä¸€ç§åœ¨ä¸åŒæŠ½è±¡å±‚æ¬¡ä¸Šäº¤æµè½¯ä»¶æ¶æ„çš„ç®€å•æ–¹æ³•ï¼Œå¯ä»¥å‘ä¸åŒçš„å—ä¼—è®²è¿°ä¸åŒçš„æ•…äº‹ã€‚è¿™ä¹Ÿæ˜¯å‘è½¯ä»¶å¼€å‘å›¢é˜Ÿä»‹ç»ï¼ˆé€šå¸¸æ˜¯é‡æ–°å¼•å…¥ï¼‰ä¸¥è°¨å’Œè½»é‡çº§å»ºæ¨¡çš„ä¸€ç§æ–¹å¼ã€‚æœ‰å…³ C4 æ¨¡å‹çš„æ›´å¤šä¿¡æ¯ï¼Œä»¥åŠè¡¥å……å›¾ï¼ˆè¿è¡Œæ—¶å’Œéƒ¨ç½²ï¼‰çš„ç¤ºä¾‹ã€ç¬¦å·æ¸…å•ã€å¸¸è§é—®é¢˜è§£ç­”ã€ä¼šè®®è®²åº§è§†é¢‘å’Œå·¥å…·é€‰é¡¹ï¼Œè¯·å‚é˜… [c4model.com](https://c4model.com) ã€‚
## ç¯å¢ƒå‡†å¤‡

C4 æ¨¡å‹æœ¬èº«æ˜¯ä¸€ç§æ¶æ„å›¾ç»˜åˆ¶çš„ç»„ç»‡ç†å¿µã€æ–¹æ³•è®ºï¼Œå¹¶ä¸é™äºä½¿ç”¨ä»€ä¹ˆå·¥å…·ã€‚C4ä½œè€…æ¨èä½¿ç”¨ï¼š

* C4PlantUML
* Structurizr 

æœ¬æ–‡é€‰ç”¨çš„ç¯å¢ƒæ˜¯ :
* Visual Studio Code (IDE) 
* PlantUML 
* PlantUML  Extensionï¼ˆVS Code extensionï¼‰ 
* C4-PlantUML (library)

1. Visual Studio Code  ç›´æ¥æœç´¢å®‰è£…
2. PlantUML
 PlantUMLéœ€è¦JAVA ã€Graphviz è¿è¡Œç¯å¢ƒ éJAVAå¼€å‘è€… å®‰è£…èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚
 Windows ç”¨æˆ·å¯ä»¥ä½¿ç”¨[choco](https://chocolatey.org/install) åŒ…ç®¡ç†å·¥å…· 
 å¦‚æœæ²¡æœ‰choco å¯ç›´æ¥ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤ç›´æ¥å®‰è£… Choco å’Œ PlantUML
 
 ``` PowerShell
 @"%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe" -NoProfile -ExecutionPolicy Bypass -Command "iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))" && SET "PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"

choco install plantuml
 ```
 å®‰è£…å®Œæˆè¿˜ä¼šåœ¨æ¡Œé¢ä¿å­˜ä¸€ä¸ª plantuml æ–‡æ¡£ ä¾›å‚è€ƒå­¦ä¹ 
3. VS Code  å®‰è£… PlantUML æ‰©å±• 
![img](/img/post-2023-01/plantuml.png)
4. C4-PlantUML (åŒ…å« C4 Model ç‰¹æœ‰ çš„å›¾å½¢ã€ç¬¦å·) éœ€è¦åœ¨ **.puml** æ–‡ä»¶ä¸­å¼•å…¥ç›¸å…³åŒ… ã€‚

å¦‚æœæ€»æ˜¯æƒ³ä½¿ç”¨æœ€æ–°çš„ç‰ˆæœ¬å°±å¼•å…¥

    !include  "https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml"

å›½å†…å¼•ç”¨è¿™ä¸ªåœ°å€å¤§æ¦‚ç‡ä¼šè¢«ğŸ§± <br>
å¸¸è§„ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¼•ç”¨å³å¯ã€‚

    !include <C4/C4_Container>

å¦‚å¿…é¡»ä½¿ç”¨æœ€æ–°å¯å‰å¾€[plantuml-stdlib/C4-PlantUML](https://github.com/plantuml-stdlib/C4-PlantUML)ä»“åº“ä¿å­˜åˆ°æœ¬åœ°ä¹ŸğŸ‰‘ï¼Œå…·ä½“æ–¹æ³•è‡ªè¡Œç™¾åº¦ã€‚
## åŸºç¡€è¯­æ³•

æ— è®ºæ˜¯æ—¶åºå›¾ ã€æ´»åŠ¨å›¾ã€ç»„ä»¶å›¾ã€çŠ¶æ€å›¾ ä»–ä»¬ä¸»è¦æè¿°éƒ½æ˜¯ å•ç‹¬ä¸»ä½“çš„è¯¦æƒ…æˆ–è€… ä¸»ä½“ä¸ä¸»ä½“ä¹‹é—´çš„å…³ç³»ã€‚
* ä¸»ä½“å¯ä»¥æ˜¯æœåŠ¡ã€å¯¹è±¡ã€çŠ¶æ€ã€ç»„ä»¶ç­‰ç­‰ï¼› 
* å…³ç³»åˆ™å¯ä»¥æ˜¯ç½‘ç»œè¯·æ±‚ã€ä¾èµ–å…³ç³»ã€æ¥å£è°ƒç”¨ã€ç»§æ‰¿å…³ç³»ç­‰ç­‰ã€‚

**ä¸»ä½“** ä½¿ç”¨component ã€Containerã€ Systemã€ ContainerDbç­‰ç­‰å„ç§å„æ ·çš„å…³é”®å­—æ¥å¼•ç”¨æ°å½“çš„å›¾å½¢å±•ç¤ºå¯¹è±¡æ€§è´¨ï¼Œå†è¾…ä»¥æ–‡å­—æè¿°å³å¯æè¿°æ¸…æ¥šä¸»ä½“ä¿¡æ¯<br>
**å…³ç³»** åˆ™ç”¨å„ç§å„æ ·çš„è¿æ¥çº¿ æ¥æè¿°ä¸»ä½“ä¸ä¸»ä½“ä¹‹é—´çš„è”ç³»ã€ä¾èµ–ã€å…³ç³»ã€‚

#### ä¸»ä½“
å‚æ•°è¯´æ˜ ï¼š
* alias å˜é‡å
* label æ ‡ç­¾å
* descr æè¿°ä¿¡æ¯
* sprite å›¾æ ‡ å¯ä½¿ç”¨ scale ç¼©å°æ”¾å¤§å›¾æ ‡  etc.  $sprite="person2,scale=0.5"
* link å¤–é“¾
* techn ä½¿ç”¨æŠ€æœ¯
* tags æ ‡ç­¾ å¤šæ ‡ç­¾ä½¿ç”¨ '+'åˆ†éš”

C4_Context.puml åŒ…ä¸­å…³é”®å­—ï¼š

Macros:
* Person(alias, label, ?descr, ?sprite, ?tags, ?link)
* Person_Ext
* System(alias, label, ?descr, ?sprite, ?tags, ?link)
* SystemDb
* SystemQueue
* System_Ext
* SystemDb_Ext
* SystemQueue_Ext
* Boundary(alias, label, ?type, ?tags, ?link)
* Enterprise_Boundary(alias, label, ?tags, ?link)
* System_Boundary

C4_Container.pumlï¼š

Macros:
* Container(alias, label, ?techn, ?descr, ?sprite, ?tags, ?link)
* ContainerDb
* ContainerQueue
* Container_Ext
* ContainerDb_Ext
* ContainerQueue_Ext
* Container_Boundary(alias, label, ?tags, ?link)

C4_Component.puml
Macros:
* Component(alias, label, ?techn, ?descr, ?sprite, ?tags, ?link)
* ComponentDb
* ComponentQueue
* Component_Ext
* ComponentDb_Ext
* ComponentQueue_Ext

#### å…³è”

* Rel(from, to, label, ?techn, ?descr, ?sprite, ?tags, ?link)
* BiRel (bidirectional relationship)
 
ä¹Ÿå¯ä»¥å¼ºåˆ¶æŒ‡å®šå…³ç³»è¿çº¿æ–¹å‘
* Rel_U, Rel_Up
* Rel_D, Rel_Down
* Rel_L, Rel_Left
* Rel_R, Rel_Right

#### å…¶ä»–

æ˜¾ç¤ºç®€ä»‹ï¼š
*  LAYOUT_WITH_LEGEND()  å±•ç¤ºæ‰€æœ‰
*  SHOW_FLOATING_LEGEND(?hideStereotype, ?details)  åªå±•ç¤ºç”¨åˆ°çš„ è€Œä¸”å¯ç²¾ç»†æ§åˆ¶å±•ç¤ºå¤§å°ç­‰ç­‰
* ... 

è‡ªå®šä¹‰è·ç¦»ï¼š<br>
* Lay_Distance(from, to, ?distance) <br>æŒ‡å®šä¸»ä½“ä¸ä¸»ä½“è·ç¦»

æŒ‡å®šå¸ƒå±€æ–¹å‘:
* LAYOUT_TOP_DOWN()
* LAYOUT_LEFT_RIGHT()
* ....

C4 Model è¿˜æœ‰è¯¸å¦‚æŒ‡å®šä½ç½®å…³ç³»ã€è‡ªå®šä¹‰å›¾æ ‡ç­‰ç­‰å®Œå–„çš„åŠŸèƒ½ï¼Œä½†ä¸ºé¡¹ç›®ç»˜åˆ¶C4Model å›¾è¿™äº›é¢„å…ˆçŸ¥è¯†åŸºæœ¬å°±å¤Ÿäº†ï¼Œå¦‚æœ‰å…¶ä»–è¯·è‡ªè¡ŒæŸ¥é˜…å®˜æ–¹æ–‡æ¡£ã€‚

## ç®€å•ç¤ºä¾‹
``` plantuml.puml
@startuml C4_Elements 
' å¼•ç”¨åº“æ–‡ä»¶
!include <C4/C4_Container>
' æ ‡é¢˜
title C4_Elements 
' å£°æ˜ä¸»ä½“
Person(admin, "Administrator", $sprite="person2", $link="https://github.com/plantuml-stdlib/C4-PlantUML/blob/master/LayoutOptions.md#hide_person_sprite-or-show_person_spritesprite")
System_Boundary(c1, "Sample System", $link="https://github.com/plantuml-stdlib/C4-PlantUML") {
    Container(web_app, "Web Application", "C#, ASP.NET Core 2.1 MVC", $descr="Allows users to compare multiple Twitter timelines", $link="https://github.com/plantuml-stdlib/C4-PlantUML/blob/master/LayoutOptions.md")
}
System(twitter, "Twitter", $link="https://github.com/plantuml-stdlib/C4-PlantUML")
' å£°æ˜å…³ç³»
Rel(admin, web_app, "Uses", "HTTPS", $link="https://plantuml.com/link")
Rel(web_app, twitter, "Gets tweets from", "HTTPS", $link="https://plantuml.com/link")
@enduml
```

![etc-c4-plantuml.png](/img/post-2023-01/etc-c4-plantuml.png)

 


